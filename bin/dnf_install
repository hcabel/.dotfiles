#!/bin/bash

# Update package database and upgrade all packages
sudo dnf -y upgrade
if [ $? -ne 0 ]; then
    echo "Failed to update and upgrade packages."
    exit 1
fi

# Install required packages
packages=(
    "dnf:jq"                    # Json parser
    "dnf:stow"                  # Needed for config linking
    "dnf:zoxide"                # better cd command
    "dnf:eza"                   # modern ls replacement
    "dnf:fish"                  # Shell
    "dnf:lazygit"               # git overpowered TUI
    "dnf:waybar"                # status bar
    "flatpak:app.zen_browser.zen" # Browser
    "dnf:discord"
    "dnf:alacritty"             # terminal emulator
    "dnf:hyprlock"              # screen locker
    "dnf:hyprsunset"            # automatic brightness and color temperature adjustment
    "dnf:hypridle"              # automatic screen locking on idle
    "dnf:rust"                  # Rust programming language
    "dnf:cargo"                 # Rust package manager
    "dnf:pkgconf-pkg-config"
    "dnf:dbus-devel"
    "cargo:bluetui"             # Bluetooth TUI client

    # Dev tools
    "dnf:nvim"                  # Code editor
    "dnf:rust-analyzer"         # Rust language server
    # TODO [hcabel 2026-01-06]: lua-language-server
    "dnf:gopls"
    # TODO [hcabel 2026-01-06]: typescript-language-server
    # TODO [hcabel 2026-01-06]: ccls
    "dnf:tree-sitter-cli"       # for nvim treesitter
)

for package in "${packages[@]}"; do
    echo ""
    echo ">> Installing: \"$package\" <<"
    IFS=":" read -r manager pkg_name <<< "$package"
    case $manager in
        "dnf")
            sudo dnf install -y "$pkg_name"
            if [ $? -ne 0 ]; then
                echo "DNF installation failed ($pkg_name)."
                exit 1
            fi
            ;;
        "flatpak")
            flatpak install -y "$pkg_name"
            if [ $? -ne 0 ]; then
                echo "Flatpak installation failed ($pkg_name)."
                exit 1
            fi
            ;;
        "cargo")
            cargo install "$pkg_name"
            if [ $? -ne 0 ]; then
                echo "Cargo installation failed ($pkg_name)."
                exit 1
            fi
            ;;
        *)
            echo "Unknown package manager: $manager"
            exit 1
            ;;
    esac
done
